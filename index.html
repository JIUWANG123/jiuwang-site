<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>九妄的领域</title>
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <style>
    :root {
      --main-red: #660000;
      --text-light: #e6e6e6;
      --bg-dark: #0d0d0d;
      --popup-zindex: 10000;
    }

    /* 修正后的动画定义 */
    @keyframes fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 0.8;
      }
      100% {
        transform: translateY(120vh) rotate(360deg);
        opacity: 0;
      }
    }

    .popup {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      border: 1px solid var(--main-red);
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
      z-index: var(--popup-zindex);
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      padding: 2em;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
  </style>
</head>
<body>
<!-- 修正音频标签闭合顺序 -->
<div id="bg-audio-wrapper" style="position:fixed; bottom:10px; right:10px; z-index:9999; background:#1a1a1a; border:1px solid #660000; border-radius:8px; padding:4px; opacity:0.95;">
  <audio id="bg-music" src="/static/music/theme.mp3" controls loop autoplay style="max-width:300px;"></audio>
</div>

<!-- 各功能区块 -->
<section id="updates" class="section-wrapper gothic-box popup" style="display:none;">
  <!-- 修正后的弹出层样式 -->
</section>

<script>
// 修正后的renderAbout函数
document.addEventListener('DOMContentLoaded', () => {
  const editBtn = document.getElementById('edit-about')
  const editBox = document.getElementById('about-edit-box')
  const editor = document.getElementById('about-editor')
  const saveBtn = document.getElementById('save-about')
  const pwInput = document.getElementById('about-pass')

  function renderAbout() {
    fetch('/about')
      .then(res => res.text())
      .then(text => {
        const lines = text.trim().split('\n')
        document.getElementById('nickname').innerText = lines[0] || ''
        document.getElementById('birthday').innerText = lines[1] || ''
        document.getElementById('mbti').innerText = lines[2] || ''
        document.getElementById('bio').innerText = lines.slice(3).join(' ') || ''
      })
  }

  editBtn.addEventListener('click', () => {
    const current = Array.from(document.querySelectorAll('#about p span')).map(span => span.innerText).join('\n')
    editor.value = current
    editBox.style.display = 'block'
  })

  saveBtn.addEventListener('click', () => {
    const pw = pwInput.value.trim()
    const content = editor.value.trim()
    if (!content || pw !== '852') return alert('密码错误或内容为空')
    fetch('/about', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, pw })
    }).then(() => {
      renderAbout()
      editBox.style.display = 'none'
      pwInput.value = ''
    })
  })

  renderAbout()
})

// 增加拖动边界检测
document.addEventListener('DOMContentLoaded', () => {
  const wrapper = document.getElementById('bg-audio-wrapper')
  let isDragging = false, offsetX, offsetY

  function constrainPosition(x, y) {
    const rect = wrapper.getBoundingClientRect()
    x = Math.max(0, Math.min(x, window.innerWidth - rect.width))
    y = Math.max(0, Math.min(y, window.innerHeight - rect.height))
    return [x, y]
  }

  wrapper.addEventListener('mousedown', e => {
    isDragging = true
    offsetX = e.clientX - wrapper.offsetLeft
    offsetY = e.clientY - wrapper.offsetTop
    wrapper.style.cursor = 'move'
  })

  document.addEventListener('mousemove', e => {
    if (!isDragging) return
    let x = e.clientX - offsetX
    let y = e.clientY - offsetY
    [x, y] = constrainPosition(x, y)
    wrapper.style.left = x + 'px'
    wrapper.style.top = y + 'px'
    wrapper.style.bottom = 'auto'
    wrapper.style.right = 'auto'
  })
})
</script>
</body>
</html>